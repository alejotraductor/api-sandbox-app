{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) {\n    if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  }\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nexports.__esModule = true;\n/**\n * Card Service file\n */\n\nvar Identifiers_1 = require(\"./../../lib/constant/Identifiers\");\n\nvar dot = require(\"dot-object\");\n\nvar KushkiError_1 = require(\"./../../lib/generic/KushkiError\");\n\nvar ErrorEnum_1 = require(\"./../../lib/infrastructure/ErrorEnum\");\n\nvar inversify_1 = require(\"inversify\");\n\nrequire(\"reflect-metadata\");\n\nvar operators_1 = require(\"rxjs/operators\");\n/**\n * Implementation\n */\n\n\nvar CardService =\n/** @class */\nfunction () {\n  function CardService(gateway, antiFraud) {\n    this._gateway = gateway;\n    this._antiFraud = antiFraud;\n    this._receipt = {\n      amount: \"totalAmount\",\n      \"card.cvc\": \"card.cvv\",\n      \"card.expiryMonth\": \"card.expiryMonth\",\n      \"card.expiryYear\": \"card.expiryYear\",\n      \"card.name\": \"card.name\",\n      \"card.number\": \"card.number\",\n      currency: \"currency\",\n      isDeferred: \"isDeferred\",\n      months: \"months\",\n      sessionId: \"sessionId\",\n      userId: \"userId\"\n    };\n  }\n\n  CardService.prototype.requestToken = function (request, mid, isTest, regional) {\n    var _this = this;\n\n    return this._gateway.requestMerchantSettings(mid, isTest, regional).pipe(operators_1.switchMap(function (merchant) {\n      return _this._getScienceSession(request, mid, isTest, merchant);\n    }), operators_1.map(function (siftObject) {\n      request.isDeferred = request.isDeferred === undefined ? false : request.isDeferred;\n\n      _this._checkRequestBody(request);\n\n      return dot.transform(_this._receipt, __assign({}, request, siftObject));\n    }), operators_1.switchMap(function (finalRequest) {\n      return _this._gateway.requestToken(finalRequest, mid, isTest, regional);\n    }));\n  };\n\n  CardService.prototype.requestTokenCharge = function (request, mid, isTest, regional) {\n    var _this = this;\n\n    return this._gateway.requestMerchantSettings(mid, isTest, regional).pipe(operators_1.switchMap(function (merchant) {\n      return _this._antiFraud.createSiftScienceSession(request.subscriptionId, \"\", mid, isTest, merchant);\n    }), operators_1.switchMap(function (siftObject) {\n      return _this._gateway.requestTokenCharge(__assign({\n        subscriptionId: request.subscriptionId\n      }, siftObject), mid, isTest, regional);\n    }));\n  };\n\n  CardService.prototype.requestSubscriptionToken = function (subscriptionTokenRequest, mid, isTest, regional) {\n    var _this = this;\n\n    return this._gateway.requestMerchantSettings(mid, isTest, regional).pipe(operators_1.switchMap(function (merchant) {\n      return _this._getScienceSession(subscriptionTokenRequest, mid, isTest, merchant);\n    }), operators_1.map(function (siftObject) {\n      _this._checkRequestBody(subscriptionTokenRequest);\n\n      if (siftObject.userId === null || siftObject.sessionId === null) return dot.transform(_this._receipt, __assign({}, subscriptionTokenRequest));\n      return dot.transform(_this._receipt, __assign({}, subscriptionTokenRequest, siftObject));\n    }), operators_1.switchMap(function (body) {\n      return _this._gateway.requestSubscriptionToken(body, mid, isTest, regional);\n    }));\n  };\n\n  CardService.prototype.requestDeferred = function (binBody, mid, isTest, regional) {\n    return this._gateway.requestDeferredConditions(mid, binBody.bin, isTest, regional);\n  };\n\n  CardService.prototype.requestBinInfo = function (binBody, mid, isTest, regional) {\n    return this._gateway.requestBinInfo(mid, binBody.bin, isTest, regional);\n  };\n\n  CardService.prototype._checkCardLength = function (request) {\n    if (request.card.number.length < 14 || request.card.number.length > 19) throw new KushkiError_1.KushkiError(ErrorEnum_1.ERRORS.E005);\n  };\n\n  CardService.prototype._getScienceSession = function (request, mid, isTest, merchant) {\n    return this._antiFraud.createSiftScienceSession(request.card.number.substring(0, 6), request.card.number.slice(-4), mid, isTest, merchant);\n  };\n\n  CardService.prototype._checkCurrency = function (request) {\n    request.currency = request.currency === undefined ? \"USD\" : request.currency;\n  };\n\n  CardService.prototype._checkAmount = function (request) {\n    if (request.amount !== undefined && typeof request.amount === \"string\") request.amount = parseFloat(request.amount);\n  };\n\n  CardService.prototype._checkRequestBody = function (request) {\n    this._checkCurrency(request);\n\n    this._checkCardLength(request);\n\n    this._checkAmount(request);\n  };\n\n  CardService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(Identifiers_1.IDENTIFIERS.KushkiGateway)), __param(1, inversify_1.inject(Identifiers_1.IDENTIFIERS.AntiFraud)), __metadata(\"design:paramtypes\", [Object, Object])], CardService);\n  return CardService;\n}();\n\nexports.CardService = CardService;","map":{"version":3,"sources":["/Users/annaortega/Documents/workspace/api-sandbox-app/node_modules/@kushki/js/lib/service/CardService.js"],"names":["__assign","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","__decorate","decorators","target","key","desc","c","r","getOwnPropertyDescriptor","d","Reflect","decorate","defineProperty","__metadata","k","v","metadata","__param","paramIndex","decorator","exports","__esModule","Identifiers_1","require","dot","KushkiError_1","ErrorEnum_1","inversify_1","operators_1","CardService","gateway","antiFraud","_gateway","_antiFraud","_receipt","amount","currency","isDeferred","months","sessionId","userId","requestToken","request","mid","isTest","regional","_this","requestMerchantSettings","pipe","switchMap","merchant","_getScienceSession","map","siftObject","undefined","_checkRequestBody","transform","finalRequest","requestTokenCharge","createSiftScienceSession","subscriptionId","requestSubscriptionToken","subscriptionTokenRequest","body","requestDeferred","binBody","requestDeferredConditions","bin","requestBinInfo","_checkCardLength","card","number","KushkiError","ERRORS","E005","substring","slice","_checkCurrency","_checkAmount","parseFloat","injectable","inject","IDENTIFIERS","KushkiGateway","AntiFraud"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = (this && this.__metadata) || function (k, v) {\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\n    return function (target, key) { decorator(target, key, paramIndex); }\n};\nexports.__esModule = true;\n/**\n * Card Service file\n */\nvar Identifiers_1 = require(\"./../../lib/constant/Identifiers\");\nvar dot = require(\"dot-object\");\nvar KushkiError_1 = require(\"./../../lib/generic/KushkiError\");\nvar ErrorEnum_1 = require(\"./../../lib/infrastructure/ErrorEnum\");\nvar inversify_1 = require(\"inversify\");\nrequire(\"reflect-metadata\");\nvar operators_1 = require(\"rxjs/operators\");\n/**\n * Implementation\n */\nvar CardService = /** @class */ (function () {\n    function CardService(gateway, antiFraud) {\n        this._gateway = gateway;\n        this._antiFraud = antiFraud;\n        this._receipt = {\n            amount: \"totalAmount\",\n            \"card.cvc\": \"card.cvv\",\n            \"card.expiryMonth\": \"card.expiryMonth\",\n            \"card.expiryYear\": \"card.expiryYear\",\n            \"card.name\": \"card.name\",\n            \"card.number\": \"card.number\",\n            currency: \"currency\",\n            isDeferred: \"isDeferred\",\n            months: \"months\",\n            sessionId: \"sessionId\",\n            userId: \"userId\"\n        };\n    }\n    CardService.prototype.requestToken = function (request, mid, isTest, regional) {\n        var _this = this;\n        return this._gateway.requestMerchantSettings(mid, isTest, regional).pipe(operators_1.switchMap(function (merchant) {\n            return _this._getScienceSession(request, mid, isTest, merchant);\n        }), operators_1.map(function (siftObject) {\n            request.isDeferred =\n                request.isDeferred === undefined ? false : request.isDeferred;\n            _this._checkRequestBody(request);\n            return dot.transform(_this._receipt, __assign({}, request, siftObject));\n        }), operators_1.switchMap(function (finalRequest) {\n            return _this._gateway.requestToken(finalRequest, mid, isTest, regional);\n        }));\n    };\n    CardService.prototype.requestTokenCharge = function (request, mid, isTest, regional) {\n        var _this = this;\n        return this._gateway.requestMerchantSettings(mid, isTest, regional).pipe(operators_1.switchMap(function (merchant) {\n            return _this._antiFraud.createSiftScienceSession(request.subscriptionId, \"\", mid, isTest, merchant);\n        }), operators_1.switchMap(function (siftObject) {\n            return _this._gateway.requestTokenCharge(__assign({ subscriptionId: request.subscriptionId }, siftObject), mid, isTest, regional);\n        }));\n    };\n    CardService.prototype.requestSubscriptionToken = function (subscriptionTokenRequest, mid, isTest, regional) {\n        var _this = this;\n        return this._gateway.requestMerchantSettings(mid, isTest, regional).pipe(operators_1.switchMap(function (merchant) {\n            return _this._getScienceSession(subscriptionTokenRequest, mid, isTest, merchant);\n        }), operators_1.map(function (siftObject) {\n            _this._checkRequestBody(subscriptionTokenRequest);\n            if (siftObject.userId === null || siftObject.sessionId === null)\n                return dot.transform(_this._receipt, __assign({}, subscriptionTokenRequest));\n            return dot.transform(_this._receipt, __assign({}, subscriptionTokenRequest, siftObject));\n        }), operators_1.switchMap(function (body) {\n            return _this._gateway.requestSubscriptionToken(body, mid, isTest, regional);\n        }));\n    };\n    CardService.prototype.requestDeferred = function (binBody, mid, isTest, regional) {\n        return this._gateway.requestDeferredConditions(mid, binBody.bin, isTest, regional);\n    };\n    CardService.prototype.requestBinInfo = function (binBody, mid, isTest, regional) {\n        return this._gateway.requestBinInfo(mid, binBody.bin, isTest, regional);\n    };\n    CardService.prototype._checkCardLength = function (request) {\n        if (request.card.number.length < 14 || request.card.number.length > 19)\n            throw new KushkiError_1.KushkiError(ErrorEnum_1.ERRORS.E005);\n    };\n    CardService.prototype._getScienceSession = function (request, mid, isTest, merchant) {\n        return this._antiFraud.createSiftScienceSession(request.card.number.substring(0, 6), request.card.number.slice(-4), mid, isTest, merchant);\n    };\n    CardService.prototype._checkCurrency = function (request) {\n        request.currency =\n            request.currency === undefined ? \"USD\" : request.currency;\n    };\n    CardService.prototype._checkAmount = function (request) {\n        if (request.amount !== undefined && typeof request.amount === \"string\")\n            request.amount = parseFloat(request.amount);\n    };\n    CardService.prototype._checkRequestBody = function (request) {\n        this._checkCurrency(request);\n        this._checkCardLength(request);\n        this._checkAmount(request);\n    };\n    CardService = __decorate([\n        inversify_1.injectable(),\n        __param(0, inversify_1.inject(Identifiers_1.IDENTIFIERS.KushkiGateway)),\n        __param(1, inversify_1.inject(Identifiers_1.IDENTIFIERS.AntiFraud)),\n        __metadata(\"design:paramtypes\", [Object, Object])\n    ], CardService);\n    return CardService;\n}());\nexports.CardService = CardService;\n"]},"metadata":{},"sourceType":"script"}