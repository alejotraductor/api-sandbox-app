{"ast":null,"code":"\"use strict\";\n/**\n * MobileProcessor Service file\n */\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) {\n    if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  }\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nexports.__esModule = true;\n\nvar Identifiers_1 = require(\"./../../lib/constant/Identifiers\");\n\nvar KushkiError_1 = require(\"./../../lib/generic/KushkiError\");\n\nvar ErrorEnum_1 = require(\"./../../lib/infrastructure/ErrorEnum\");\n\nvar inversify_1 = require(\"inversify\");\n\nvar rxjs_1 = require(\"rxjs\");\n\nvar operators_1 = require(\"rxjs/operators\");\n\nvar MobileProcessorService =\n/** @class */\nfunction () {\n  function MobileProcessorService(gateway) {\n    this._gateway = gateway;\n  } // istanbul ignore next\n\n\n  MobileProcessorService.prototype.requestToken = function (request, publicCredential, isTest, regional) {\n    var _this = this;\n\n    var token;\n    var apple_request = this.createAppleRequest(request);\n    return rxjs_1.of(1).pipe(operators_1.mergeMap(function () {\n      return new rxjs_1.Observable(function (observer) {\n        // tslint:disable-next-line:no-any\n        var apple_session = new window.ApplePaySession(2, apple_request);\n\n        apple_session.onvalidatemerchant = function (event) {\n          return _this.onvalidatemerchant(event, observer, apple_session);\n        };\n\n        apple_session.begin();\n      });\n    }), operators_1.mergeMap(function (session) {\n      return _this.requestGatewayToken(request, session, publicCredential, isTest, regional);\n    }), operators_1.mergeMap(function (_a) {\n      var session = _a[0],\n          response = _a[1];\n      token = response.token;\n      delete response.token;\n      session.session.completeMerchantValidation(response);\n      return rxjs_1.of(session);\n    }), operators_1.mergeMap(function (session) {\n      return new rxjs_1.Observable(function (observer) {\n        session.session.onpaymentauthorized = function (event) {\n          observer.next({\n            payment_token: event.payment,\n            session: session.session\n          });\n        };\n      });\n    }), operators_1.mergeMap(function (session) {\n      session.session.completePayment( // tslint:disable-next-line:no-any\n      window.ApplePaySession.STATUS_SUCCESS);\n      return rxjs_1.of({\n        token: token,\n        paymentToken: session.payment_token\n      });\n    }), operators_1.catchError(function (error) {\n      if (error.message === \"The object does not support the operation or argument.\") return rxjs_1.throwError(new KushkiError_1.KushkiError(ErrorEnum_1.ERRORS.E006));\n      return rxjs_1.throwError(error);\n    }));\n  };\n\n  MobileProcessorService.prototype.requestGatewayToken = function (request, session, publicCredential, isTest, regional) {\n    request.validationUrl = session.validation_url;\n    request.domainName = session.current_url;\n    delete request.description;\n    return rxjs_1.forkJoin([rxjs_1.of(session), this._gateway.requestMobileProcessorToken(request, publicCredential, isTest, regional)]).pipe(operators_1.catchError(function (err) {\n      session.session.abort();\n      return rxjs_1.throwError(err);\n    }));\n  };\n\n  MobileProcessorService.prototype.requestGatewayCharge = function (token, publicCredential, isTest, regional, request, session) {\n    var charge_request = {\n      token: token,\n      amount: request.totalAmount,\n      currency: request.currency,\n      encodedPaymentToken: session.payment_token,\n      softDescriptor: \"KushkiPagos\"\n    };\n    return rxjs_1.forkJoin([rxjs_1.of(session), this._gateway.chargeMobileProcessor(charge_request, publicCredential, isTest, regional)]);\n  };\n\n  MobileProcessorService.prototype.createAppleRequest = function (request) {\n    return {\n      countryCode: \"US\",\n      currencyCode: \"USD\",\n      merchantCapabilities: [\"supports3DS\"],\n      requiredBillingContactFields: [\"postalAddress\", \"name\"],\n      requiredShippingContactFields: [\"postalAddress\", \"email\", \"phone\"],\n      supportedNetworks: [\"amex\", \"discover\", \"jcb\", \"masterCard\", \"visa\"],\n      total: {\n        amount: request.totalAmount,\n        label: request.description,\n        type: \"final\"\n      }\n    };\n  };\n\n  MobileProcessorService.prototype.completePayment = function (session, response) {\n    session.session.completePayment( // tslint:disable-next-line:no-any\n    window.ApplePaySession.STATUS_SUCCESS);\n    return rxjs_1.of(response);\n  };\n\n  MobileProcessorService.prototype.onvalidatemerchant = function (event, observer, session) {\n    var validation_url = event.validationURL;\n    var current_url = window.location.host;\n    observer.next({\n      current_url: current_url,\n      validation_url: validation_url,\n      session: session\n    });\n  };\n\n  MobileProcessorService.prototype.paymentAuthorized = function (event, observer, session) {\n    var payment_token = event.payment;\n    observer.next({\n      payment_token: payment_token,\n      session: session.session\n    });\n  };\n\n  MobileProcessorService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(Identifiers_1.IDENTIFIERS.KushkiGateway)), __metadata(\"design:paramtypes\", [Object])], MobileProcessorService);\n  return MobileProcessorService;\n}();\n\nexports.MobileProcessorService = MobileProcessorService;","map":{"version":3,"sources":["/Users/annaortega/Documents/workspace/api-sandbox-app/node_modules/@kushki/js/lib/service/MobileProcessorService.js"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__metadata","k","v","metadata","__param","paramIndex","decorator","exports","__esModule","Identifiers_1","require","KushkiError_1","ErrorEnum_1","inversify_1","rxjs_1","operators_1","MobileProcessorService","gateway","_gateway","prototype","requestToken","request","publicCredential","isTest","regional","_this","token","apple_request","createAppleRequest","of","pipe","mergeMap","Observable","observer","apple_session","window","ApplePaySession","onvalidatemerchant","event","begin","session","requestGatewayToken","_a","response","completeMerchantValidation","onpaymentauthorized","next","payment_token","payment","completePayment","STATUS_SUCCESS","paymentToken","catchError","error","message","throwError","KushkiError","ERRORS","E006","validationUrl","validation_url","domainName","current_url","description","forkJoin","requestMobileProcessorToken","err","abort","requestGatewayCharge","charge_request","amount","totalAmount","currency","encodedPaymentToken","softDescriptor","chargeMobileProcessor","countryCode","currencyCode","merchantCapabilities","requiredBillingContactFields","requiredShippingContactFields","supportedNetworks","total","label","type","validationURL","location","host","paymentAuthorized","injectable","inject","IDENTIFIERS","KushkiGateway"],"mappings":"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","sourcesContent":["\"use strict\";\n/**\n * MobileProcessor Service file\n */\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = (this && this.__metadata) || function (k, v) {\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\n    return function (target, key) { decorator(target, key, paramIndex); }\n};\nexports.__esModule = true;\nvar Identifiers_1 = require(\"./../../lib/constant/Identifiers\");\nvar KushkiError_1 = require(\"./../../lib/generic/KushkiError\");\nvar ErrorEnum_1 = require(\"./../../lib/infrastructure/ErrorEnum\");\nvar inversify_1 = require(\"inversify\");\nvar rxjs_1 = require(\"rxjs\");\nvar operators_1 = require(\"rxjs/operators\");\nvar MobileProcessorService = /** @class */ (function () {\n    function MobileProcessorService(gateway) {\n        this._gateway = gateway;\n    }\n    // istanbul ignore next\n    MobileProcessorService.prototype.requestToken = function (request, publicCredential, isTest, regional) {\n        var _this = this;\n        var token;\n        var apple_request = this.createAppleRequest(request);\n        return rxjs_1.of(1).pipe(operators_1.mergeMap(function () {\n            return new rxjs_1.Observable(function (observer) {\n                // tslint:disable-next-line:no-any\n                var apple_session = new window.ApplePaySession(2, apple_request);\n                apple_session.onvalidatemerchant = function (event) {\n                    return _this.onvalidatemerchant(event, observer, apple_session);\n                };\n                apple_session.begin();\n            });\n        }), operators_1.mergeMap(function (session) {\n            return _this.requestGatewayToken(request, session, publicCredential, isTest, regional);\n        }), operators_1.mergeMap(function (_a) {\n            var session = _a[0], response = _a[1];\n            token = response.token;\n            delete response.token;\n            session.session.completeMerchantValidation(response);\n            return rxjs_1.of(session);\n        }), operators_1.mergeMap(function (session) {\n            return new rxjs_1.Observable(function (observer) {\n                session.session.onpaymentauthorized = function (event) {\n                    observer.next({\n                        payment_token: event.payment,\n                        session: session.session\n                    });\n                };\n            });\n        }), operators_1.mergeMap(function (session) {\n            session.session.completePayment(\n            // tslint:disable-next-line:no-any\n            window.ApplePaySession.STATUS_SUCCESS);\n            return rxjs_1.of({\n                token: token,\n                paymentToken: session.payment_token\n            });\n        }), operators_1.catchError(function (error) {\n            if (error.message ===\n                \"The object does not support the operation or argument.\")\n                return rxjs_1.throwError(new KushkiError_1.KushkiError(ErrorEnum_1.ERRORS.E006));\n            return rxjs_1.throwError(error);\n        }));\n    };\n    MobileProcessorService.prototype.requestGatewayToken = function (request, session, publicCredential, isTest, regional) {\n        request.validationUrl = session.validation_url;\n        request.domainName = session.current_url;\n        delete request.description;\n        return rxjs_1.forkJoin([\n            rxjs_1.of(session),\n            this._gateway.requestMobileProcessorToken(request, publicCredential, isTest, regional),\n        ]).pipe(operators_1.catchError(function (err) {\n            session.session.abort();\n            return rxjs_1.throwError(err);\n        }));\n    };\n    MobileProcessorService.prototype.requestGatewayCharge = function (token, publicCredential, isTest, regional, request, session) {\n        var charge_request = {\n            token: token,\n            amount: request.totalAmount,\n            currency: request.currency,\n            encodedPaymentToken: session.payment_token,\n            softDescriptor: \"KushkiPagos\"\n        };\n        return rxjs_1.forkJoin([\n            rxjs_1.of(session),\n            this._gateway.chargeMobileProcessor(charge_request, publicCredential, isTest, regional),\n        ]);\n    };\n    MobileProcessorService.prototype.createAppleRequest = function (request) {\n        return {\n            countryCode: \"US\",\n            currencyCode: \"USD\",\n            merchantCapabilities: [\"supports3DS\"],\n            requiredBillingContactFields: [\"postalAddress\", \"name\"],\n            requiredShippingContactFields: [\"postalAddress\", \"email\", \"phone\"],\n            supportedNetworks: [\"amex\", \"discover\", \"jcb\", \"masterCard\", \"visa\"],\n            total: {\n                amount: request.totalAmount,\n                label: request.description,\n                type: \"final\"\n            }\n        };\n    };\n    MobileProcessorService.prototype.completePayment = function (session, response) {\n        session.session.completePayment(\n        // tslint:disable-next-line:no-any\n        window.ApplePaySession.STATUS_SUCCESS);\n        return rxjs_1.of(response);\n    };\n    MobileProcessorService.prototype.onvalidatemerchant = function (event, observer, session) {\n        var validation_url = event.validationURL;\n        var current_url = window.location.host;\n        observer.next({ current_url: current_url, validation_url: validation_url, session: session });\n    };\n    MobileProcessorService.prototype.paymentAuthorized = function (event, observer, session) {\n        var payment_token = event.payment;\n        observer.next({ payment_token: payment_token, session: session.session });\n    };\n    MobileProcessorService = __decorate([\n        inversify_1.injectable(),\n        __param(0, inversify_1.inject(Identifiers_1.IDENTIFIERS.KushkiGateway)),\n        __metadata(\"design:paramtypes\", [Object])\n    ], MobileProcessorService);\n    return MobileProcessorService;\n}());\nexports.MobileProcessorService = MobileProcessorService;\n"]},"metadata":{},"sourceType":"script"}